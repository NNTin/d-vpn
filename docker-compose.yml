version: '3.8'

# This Docker Compose file sets up the local development environment for D-VPN.
# It includes Headscale for VPN coordination, Keycloak for authentication,
# a WireGuard server to act as the home node, and a UI for Headscale.

services:
  headscale:
    image: headscale/headscale:latest
    container_name: headscale
    volumes:
      - ./headscale/config:/etc/headscale
      - ./headscale/lib:/var/lib/headscale
      - ./headscale/run:/var/run/headscale
    command: serve
    # ports:
    #   - 27896:8080
    #   - "8080:8080"  # Headscale server API
    #   - "9090:9090"  # Prometheus metrics
    networks:
      - d-vpn-net
    restart: unless-stopped
    healthcheck:
        test: ["CMD", "headscale", "health"]

  caddy:
    image: caddy:latest
    container_name: caddy
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile  # Mount your Caddyfile
    ports:
      - "8081:8081"  # Bind Caddy to localhost:8081
    depends_on:
      - headscale-ui
    networks:
      - d-vpn-net
    restart: unless-stopped

  headscale-ui:
    image: ghcr.io/gurucomputing/headscale-ui:latest
    container_name: headscale-ui
    # environment:
    #   - HS_SERVER=http://headscale:8080
    # expose:
    #   - 8443:8443
    #   - 8080:8080
    depends_on:
      - headscale
    networks:
      - d-vpn-net
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    command: start-dev --import-realm
    environment:
      # Default admin credentials for local development.
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    ports:
      - "8180:8080"  # Keycloak admin console
    volumes:
      - ./keycloak/realm-export:/opt/keycloak/data/import:ro  # Realm import for bootstrap
      - keycloak-data:/opt/keycloak/data  # Persistent data for Keycloak
    networks:
      - d-vpn-net
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  wireguard:
    image: linuxserver/wireguard:latest
    container_name: wireguard-server
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - INTERFACE=10.13.13
    volumes:
      - ./wg-config:/config  # Mount local config for WireGuard
      - /lib/modules:/lib/modules # Required for kernel modules
      - ./wg-config/custom-cont-init.d:/custom-cont-init.d # Custom init scripts
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    ports:
      - "51820:51820/udp"  # Standard WireGuard port
    networks:
      - d-vpn-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /config/wg_confs/wg0.conf && wg show all || exit 1"]
      interval: 30s                 # Check every 30 seconds
      retries: 3                    # Retry 3 times before considering unhealthy
      start_period: 10s             # Wait 10 seconds before starting checks
      timeout: 2s                   # Timeout after 2 seconds

  sync-service:
    build:
      context: ./sync-service
      dockerfile: Dockerfile
    container_name: sync-service
    environment:
      - HEADSCALE_URL=http://headscale:8080
      - HEADSCALE_API_KEY=${HEADSCALE_API_KEY}
      - WIREGUARD_CONTAINER_NAME=wireguard-server
      - WIREGUARD_CONFIG_PATH=/config
      - WIREGUARD_INTERFACE=wg0
      - WIREGUARD_SUBNET=10.13.13.0/24
      - WIREGUARD_SERVER_IP=10.13.13.1
      - WIREGUARD_PEER_START_IP=10.13.13.2
      - POLL_INTERVAL=30
      - STATE_FILE_PATH=/config/sync-service-state.json
      - API_PORT=5000
    volumes:
      - ./wg-config:/config
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "5000:5000"
    depends_on:
      - headscale
      - wireguard
    networks:
      - d-vpn-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  d-vpn-net:
    driver: bridge

volumes:
  keycloak-data:
